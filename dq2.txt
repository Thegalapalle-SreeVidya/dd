import streamlit as st
import pandas as pd
import subprocess
import os
import sys

# Function to create overview.csv
def create_overview(uploaded_file, benchmark_months, validation_month):
    # Load the input data (from the uploaded file)
    input_data = pd.read_excel(uploaded_file)  # Reading the uploaded Excel file

    # Ask user to enter Data Category (ICD or Non-ICD)
    data_category = st.selectbox("Choose Data Category", ["ICD", "Non-ICD"])

    # Filter 'target' for Inbound Country, removing blanks and duplicates
    inbound_country = input_data['target'].dropna().unique().tolist()

    # Filter 'country' for Outbound Country, removing blanks and duplicates
    outbound_country = input_data['country'].dropna().unique().tolist()

    # Convert 'Month' column from numbers to month names
    months_mapping = {
        1: 'January', 2: 'February', 3: 'March', 4: 'April', 5: 'May', 6: 'June',
        7: 'July', 8: 'August', 9: 'September', 10: 'October', 11: 'November', 12: 'December'
    }
    input_data['Month'] = input_data['Month'].map(months_mapping)

    # Create the overview DataFrame
    overview_data = {
        'Data Category': [data_category],
        'Inbound Country': [", ".join(inbound_country)],
        'Outbound Country': [", ".join(outbound_country)],
        'Period': [f"12 months({benchmark_months})"],
        'Benchmark Months': [benchmark_months],
        'Validation Month': [validation_month]
    }

    # Convert to DataFrame
    overview_df = pd.DataFrame(overview_data)

    # Save as overview.csv
    overview_df.to_csv("overview.csv", index=False)

    st.success("overview.csv file has been created!")

# Function to run Jupyter Notebook
def run_notebook(uploaded_file, benchmark_months, validation_month, nodes):
    # Save the uploaded file as 'input_file.xlsx'
    with open("input_file.xlsx", "wb") as f:
        f.write(uploaded_file.getbuffer())

    # Execute the Jupyter Notebook with specific inputs
    try:
        result = subprocess.run(
            ["jupyter", "nbconvert", "--to", "notebook", "--execute", "--inplace", "Code_Input.ipynb"],
            check=True, capture_output=True, text=True
        )
        st.success("Notebook executed successfully!")

        # Load the output CSV files or process further as needed
        merged_df = pd.read_excel('merged_df.xlsx')
        st.write(merged_df)

        # Automatically terminate this Streamlit app and run the next one
        st.write("Running Tabs.py Streamlit app...")
        subprocess.Popen(["streamlit", "run", "Tabs.py"])
        st.stop()  # Stop the current Streamlit script

    except subprocess.CalledProcessError as e:
        st.error("There was an error executing the notebook.")
        st.error(e.stdout)
        st.error(e.stderr)

# Streamlit UI
st.title("Run Jupyter Notebook with Excel Input")

# File uploader
uploaded_file = st.file_uploader("Choose an Excel file", type="xlsx")

# Parameters input
# User input for Data Category
data_category = st.selectbox("Select Data Category", options=["ICD", "Non-ICD"])
benchmark_months = st.number_input("Enter the number of Benchmark Months", min_value=1, max_value=12, value=6)
validation_month = st.number_input("Enter the month you are validating for", min_value=1, max_value=12, value=12)
nodes = st.number_input("Enter the number of nodes you want in the PSI table", min_value=1, max_value=20, value=10)

# Run notebook on button click
if st.button("Run Notebook"):
    if uploaded_file is not None:
        # Step 1: Create overview.csv before running the notebook
        create_overview(uploaded_file, benchmark_months, validation_month)
        
        # Step 2: Run the Jupyter Notebook
        run_notebook(uploaded_file, benchmark_months, validation_month, nodes)
    else:
        st.error("Please upload an Excel file")
